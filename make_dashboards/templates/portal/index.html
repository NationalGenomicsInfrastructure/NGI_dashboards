<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="NGI Stockholm Internal Dashboard">
  <meta name="author" content="Phil Ewels">
  <title>NGI Stockholm External Dashboard</title>
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <style type="text/css">
  body {
    padding-bottom: 30px;
  }
  h1 {
      margin-top: 25px;
  }
  .navbar-brand {
    padding: 9px;
  }
  .external_plot {
      margin: 40px 0;
  }
  .dashboard-timestamps {
      border-top: 1px solid #dedede;
      padding: 30px;
      color: #999;
  }
  </style>
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>
  
<nav class="navbar navbar-inverse navbar-static-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="/">
        <img src="https://ngisweden.scilifelab.se/site/favicon.png" title="NGI Sweden Order Portal" alt="NGI Sweden Order Portal">
      </a>
    </div>
    <ul class="nav navbar-nav">
      <li><a href="https://ngisweden.scilifelab.se/"><span class="glyphicon glyphicon-home"></span></a></li>
    </ul>
  </div>
</nav>

<div class="container mainrow">
  
  <h1>NGI Stockholm: Status</h1>
  
  <p>Data shown for the <a href="https://www.scilifelab.se/facilities/genomics-production/">Genomics Production</a>
    facility, who perform high-throughput sequencing followed by data processing and best practice bioinformatics analyses.
    Our automated protocols allow us to process hundreds of samples per week and produce high quality sequencing data.
    The facility is Swedac accredited, which ensure that projects are completed in accordance with rigorous quality standards.</p>
  
  <p>NGI Stockholm also has the <a href="https://www.scilifelab.se/facilities/genomics-applications/">Genomics Applications</a>
    facility which works with additional application types. Please get in touch for more information.</p>

  <div class="row">
    <div class="col-sm-6">
      <div id="open_projects_plot" class="external_plot"></div>
    </div>
    <div class="col-sm-6">
      <div id="delivery_times_plot" class="external_plot"></div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-sm-6">
      <div id="throughput_plot" class="external_plot"></div>
    </div>
    <div class="col-sm-6">
      <div id="affiliations_plot" class="external_plot"></div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-sm-6">
      <div id="num_projects_plot" class="external_plot"></div>
    </div>
    <div class="col-sm-6">
      <div id="num_samples_plot" class="external_plot"></div>
    </div>
  </div>
  
  <div class="dashboard-timestamps">
    Fetched: <span id="date_rendered">{{ d.date_rendered }}</span> &nbsp;
    <em>(<span id="report_age"></span>)</em> &nbsp; / &nbsp; 
    NGI Dashboards Package Version: <span>v{{ d.p_version }}</span>
  </div>

</div><!-- /.container -->

<script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
<script type="text/javascript">
var data = {{ d.json }};



// Javascript for the NGI Stockholm Internal Dashboard

var plot_height = 415;

$(function () {
    
    try {
    
        Highcharts.setOptions({
            colors: ['#377eb8','#4daf4a','#984ea3','#ff7f00','#a65628','#f781bf','#999999','#e41a1c'],
            chart: {
                style: {
                    fontFamily:'"Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif'
                }
            }
        });
        
        // Calculate how old the report is
        var updated = moment($('#date_rendered').text(), 'YYYY-MM-DD, HH:mm');
        $('#report_age').text(updated.from(moment()));
        
        // # Projects plot
        var years = Object.keys(data['num_projects']).sort().reverse();
        var ydata = data['num_projects'][years[0]];
        make_bar_plot('#num_projects_plot', ydata, '# Projects in '+years[0]);
        
        // # Samples plot
        var years = Object.keys(data['num_samples']).sort().reverse();
        var ydata = data['num_samples'][years[0]];
        make_bar_plot('#num_samples_plot', ydata, '# Samples in '+years[0]);
        
        // Open Projects plot
        var ydata = data['open_projects'];
        make_bar_plot('#open_projects_plot', ydata, '# Open Projects ');
        
        // Delivery times plot
        make_delivery_times_plot();
        
        // Affiliations plot
        make_affiliations_plot();
        
        // Throughput plot
        make_throughput_plot();
        
    } catch(err){
        $('.main-page').html('<div class="alert alert-danger text-center" style="margin: 100px 50px;"><p><strong>Error loading dashboard data</strong></p></div><pre style="margin: 100px 50px;"><code>'+err+'</code></pre>');
        console.log(err);
        // Try reloading in a few minutes
        setTimeout(function(){ location.reload(); }, 300000); // 5 minutes
    }
    
});


// Make a bar plot
function make_bar_plot(target, ydata, title){
    try {
        if(target === undefined){ throw 'Target missing'; }
        if(ydata === undefined){ throw 'Data missing'; }
        if(title === undefined){ title = null; }
        
        var cats = Object.keys(ydata).sort(function(a,b){return ydata[a]-ydata[b]}).reverse();
        var sorted_ydata = Array();
        var nice_cats = Array();
        var total_count = 0;
        for(j=0; j<cats.length; j++){
            if(data['key_names'][cats[j]] == undefined){
                nice_cats.push(cats[j]);
            } else {
                nice_cats.push(data['key_names'][cats[j]]);
            }
            sorted_ydata.push(ydata[cats[j]]);
            total_count += ydata[cats[j]];
        }
        
        $(target).highcharts({
            chart: {
                type: 'bar',
                height: plot_height,
                plotBackgroundColor: null,
            },
            title: {
                text: title,
                style: { 'font-size': '24px' }
            },
            subtitle: {
                text: 'Total: '+total_count
            },
            tooltip: { enabled: false },
            credits: { enabled: false },
            xAxis: {
                categories: nice_cats
            },
            yAxis: {
                min: 0,
                title: { text: null }
            },
            legend: { enabled: false },
            plotOptions: {
                bar: {
                    borderWidth: 0,
                    groupPadding: 0.1,
                    dataLabels: { enabled: true }
                },
            },
            series: [{ data: sorted_ydata }]
        });
    } catch(err) {
        $(target).addClass('coming_soon').text('coming soon');
        console.log(err);
    }
}


function make_delivery_times_plot(){
    var years = Object.keys(data['delivery_times']).sort().reverse();
    var ydata = data['delivery_times'][years[0]];
    var ykeys = Object.keys(ydata).sort(function(a,b){ return a.match(/\d+/)-b.match(/\d+/) });
    var pdata = Array();
    for(i=0; i<ykeys.length; i++){ pdata.push([ykeys[i], ydata[ykeys[i]]]); }
    var d = new Date();
    
    $('#delivery_times_plot').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            height: plot_height,
        },
        title: {
            text: 'Delivery Times in '+years[0],
            style: { 'font-size': '24px' }
        },
        subtitle: {
            text: 'Projects started '+d.getFullYear()
        },
        credits: { enabled: false },
        tooltip: {
            headerFormat: '',
            pointFormat: '<span style="color:{point.color}; font-weight:bold;">{point.name}eeks</span>: {point.y} projects'
        },
        plotOptions: {
            pie: {
                // dataLabels: { enabled: false },
                dataLabels: {
                    enabled: true,
                    formatter: function() {
                        return Math.round(this.percentage*100)/100 + ' %';
                    },
                    distance: -40,
                    style: {
                        fontWeight: 'bold',
                        color: 'white',
                        textShadow: '0px 1px 2px black',
                        'font-size': '18px'
                    }
                },
                showInLegend: true,
                startAngle: -90,
                endAngle: 90,
                size: '120%',
                center: ['50%', '75%']
            }
        },
        legend: {
            enabled: true,
            floating: true,
            y: -20
        },
        series: [{
            type: 'pie',
            name: 'Delivery Times',
            innerSize: '50%',
            data: pdata
        }]
    });
}


function make_affiliations_plot(){
    var years = Object.keys(data['project_user_affiliations']).sort().reverse();
    var ydata = data['project_user_affiliations'][years[0]];
    var ykeys = Object.keys(ydata).sort(function(a,b){return ydata[a]-ydata[b]}).reverse();
    var pdata = Array();
    for(i=0; i<ykeys.length; i++){
        var thiskey = ykeys[i];
        if(data['key_names'][thiskey] != undefined){
            thiskey = data['key_names'][thiskey];
        }
        pdata.push([thiskey, ydata[ykeys[i]]]);
        
    }
    
    $('#affiliations_plot').highcharts({
        chart: {
            plotBackgroundColor: null,
            height: plot_height,
            type:'pie'
        },
        title: {
            text: 'Project Affiliations in '+years[0],
            style: { 'font-size': '24px' }
        },
        credits: { enabled: false },
        tooltip: {
            headerFormat: '',
            pointFormat: '<span style="color:{point.color}; font-weight:bold;">{point.name}</span>: {point.y} projects'
        },
        plotOptions: {
            pie: {
                dataLabels: { enabled: false },
                showInLegend: true,
            }
        },
        legend: {
            enabled: true,
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'top',
            y: 100,
            itemStyle: {
                'font-size': '12px',
                'font-weight': 'normal'
            }
        },
        series: [{ data: pdata }]
    });
}


function make_throughput_plot(){
    var num_weeks = 12;
    var weeks = Object.keys(data['bp_seq_per_week']).sort().reverse().slice(0,num_weeks+1).reverse();
    var skeys = Array('HiseqX', 'Hiseq', 'Miseq');
    // Collect all series types
    for(i=0; i<num_weeks; i++){
        var wkeys = Object.keys(data['bp_seq_per_week'][weeks[i]]);
        for(j=0; j<wkeys.length; j++){
            if(skeys.indexOf(wkeys[j]) == -1){
                skeys.push(wkeys[j]);
            }
        }
    }
    // Collect the data
    var sdata = Array();
    var total_count = 0;
    for(j=0; j<skeys.length; j++){
        var swdata = Array();
        for(i=0; i<num_weeks; i++){
            thisdata = data['bp_seq_per_week'][weeks[i]][skeys[j]];
            swdata.push(thisdata == undefined ? 0 : thisdata);
            total_count += thisdata == undefined ? 0 : thisdata;
        }
        sdata.push({
            name: skeys[j],
            data: swdata
        });
    }
    // Subtitle text
    var bp_per_week = total_count / num_weeks;
    var mbp_per_second = (bp_per_week / (60*60*24*7))/1000000;
    var subtitle_text = 'Average per week: '+parseInt(bp_per_week/1000000000)+' Gbp ('+parseInt(mbp_per_second)+' million base pairs per second)';
    
    $('#throughput_plot').highcharts({
        chart: {
            plotBackgroundColor: null,
            height: plot_height,
            type: 'area'
        },
        title: {
            text: 'Sequencing Throughput',
            style: { 'font-size': '24px' }
        },
        subtitle: {
            text: subtitle_text
        },
        xAxis: {
            labels: {
                formatter: function() {
                    return weeks[this.value];
                },
                rotation: -30,
            },
            tickInterval: 1,
            title: { enabled: false },
        },
        yAxis: {
            title: { text: 'Base Pairs' },
            labels: {
                formatter: function () {
                    return this.value.toExponential();
                }
            }
        },
        credits: { enabled: false },
        tooltip: {
            shared: true,
            useHTML: true,
            formatter: function(){
                tt = '<strong>Week of '+weeks[this.x]+'</strong><br><table>';
                for(i=0; i<this.points.length; i++){
                    tt += '<tr><td style="padding-right: 15px;"><span style="color:'+this.points[i].color+';">'
                    tt += this.points[i].series.name+'</span>:</td><td class="text-right">'
                    tt += parseInt(this.points[i].y/1000000000)+' Gbp</td></tr>';
                }
                tt += '<tr style="border-top: 1px solid #333;"><td><strong>Total:</strong></td>';
                tt += '<td>'+parseInt(this.points[0].total/1000000000)+' Gbp</td></tr></table>';
                return tt;
            }
        },
        plotOptions: {
            area: {
                stacking: 'normal',
                lineColor: '#999999',
                lineWidth: 1,
                marker: { enabled: false }
            }
        },
        legend: {
            enabled: true,
            floating: true,
            layout: 'vertical',
            align: 'left',
            verticalAlign: 'top',
            y: 60,
            x: 90,
            itemStyle: { 'font-weight': 'normal' },
            borderWidth: 1,
            backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'),
            shadow: true
        },
        series: sdata
    });
}

</script>
</body>
</html>
